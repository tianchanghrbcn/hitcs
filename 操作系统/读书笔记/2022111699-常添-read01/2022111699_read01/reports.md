# 读书笔记：x86系统架构概览

## 1.1 系统级体系结构概览
![Global Descriptor Table 和 Local Descriptor Table 结构](https://cse.unl.edu/~goddard/Courses/CSCE351/Lectures/Lecture6.pdf)

x86架构中的系统级体系结构涉及多种寄存器、数据结构和机制，用于管理系统中的各种任务、内存和异常等。以下是几个关键的系统组件和概念：

### Global and Local Descriptor Tables
- **全局描述符表（GDT）**：存储系统范围内的段描述符，用于定义内存段的基地址、大小和访问权限。每个任务、代码段和数据段都可以有一个条目在GDT中。
- **局部描述符表（LDT）**：与GDT类似，但用于特定任务或进程的本地段描述。LDT允许每个任务定义自己的内存段，以实现任务隔离。

### System Segments, Segment Descriptors, and Gates
- **系统段**：这些段包含与系统任务相关的信息，如任务状态段（TSS）。
- **段描述符**：定义内存段的属性，包括基地址、段限长、特权级和段类型。
- **门（Gate）**：允许控制特权级之间的转移。常见的门类型包括中断门、陷阱门和调用门。门机制用于在处理系统调用或异常时，实现从用户模式到内核模式的切换。

### Task-State Segments and Task Gates
- **任务状态段（TSS）**：每个任务都有一个TSS，其中包含任务执行期间的重要信息，如栈指针、段寄存器和任务的特权级等。TSS用于任务切换时保存和恢复任务状态。
- **任务门**：允许通过硬件支持的方式，切换到另一个任务。任务门的入口位于GDT或LDT中，它包含指向另一个任务的TSS的指针。

### Interrupt and Exception Handling
- **中断和异常处理**：当硬件事件（如外部设备中断）或软件异常（如除零错误）发生时，CPU通过中断描述符表（IDT）定位并调用相应的中断服务例程（ISR）。中断处理是保护模式下关键的系统机制。

### Memory Management
- **内存管理**：x86架构支持多种内存管理方式，包括分段和分页。分页通过控制寄存器CR3来管理页表。分段则通过GDT和LDT中的段描述符实现内存段的管理。
- **分页**：是当前x86系统中常用的内存管理模式，通过页表将虚拟地址映射到物理地址。分页机制支持内存保护和虚拟化。

### System Registers
- **系统寄存器**：如GDTR（全局描述符表寄存器）、IDTR（中断描述符表寄存器）、LDTR（局部描述符表寄存器）和TR（任务寄存器），这些寄存器存储指向GDT、LDT和TSS等系统结构的指针。

## 1.2 实模式和保护模式转换
![实模式到保护模式转换](https://cse.unl.edu/~goddard/Courses/CSCE351/Lectures/Lecture6.pdf)

### 实模式
实模式是x86架构的启动模式，直接从系统加电后进入，主要目的是兼容早期的16位操作系统。实模式有以下几个特点：
- **内存地址空间**：实模式下，CPU只能访问1MB的物理内存，这种限制源自20位的地址总线（2^20 = 1MB）。
- **内存寻址方式**：实模式使用段:偏移地址模式（segment:offset）进行内存寻址。每个段可以包含64KB的数据，段寄存器决定了段的起始位置，偏移寄存器决定段内的具体位置。
- **没有内存保护**：所有代码和数据段共享同一段内存空间，没有隔离机制，这意味着任何程序都可以访问系统中的任何内存位置。
- **中断处理**：实模式下的中断处理通过中断向量表（IVT）进行，IVT是固定在内存地址 0x0000:0x0000 开始的一个表，包含指向中断处理程序的指针。

### 保护模式
保护模式是现代x86系统下使用的主要操作模式。它提供了增强的内存管理、多任务处理和保护功能，系统可以通过更大的内存地址空间和多种特权级来确保安全性。

#### 特性：
- **内存地址空间扩展**：保护模式可以访问4GB的内存空间（32位寻址），并且支持通过分页机制进一步扩展虚拟内存空间。
- **内存保护**：保护模式支持分段和分页的内存保护机制，确保程序无法随意访问不属于自己的内存区域。
- **多任务支持**：支持任务切换机制，硬件可以在多个任务之间高效切换。
- **特权级别**：保护模式定义了四个特权级（ring 0 到 ring 3），其中 ring 0 是最高特权级，通常分配给内核模式；ring 3 是最低特权级，用于用户模式。通过特权级的划分，系统可以防止低权限的应用程序执行高权限的操作。

### 从实模式到保护模式的转换过程
从实模式到保护模式的转换过程需要严格的步骤，以确保系统能够安全地启用保护模式并保持稳定。典型的转换步骤如下：
1. **关闭中断**：在进行模式转换前，需通过CLI指令关闭中断，以避免中断干扰转换过程。
2. **设置GDT**：准备好全局描述符表（GDT）并将其加载到GDTR寄存器中，GDT定义了系统的段描述符，用于控制内存的分段。
3. **启用A20地址线**：由于实模式只能访问1MB内存，启用A20地址线允许系统访问超出1MB的内存地址空间。
4. **设置CR0寄存器**：将CR0寄存器的第0位（PE，保护使能位）置1，以进入保护模式。
5. **加载新的代码段选择子**：在启用保护模式后，必须加载一个指向GDT中代码段的选择子，并跳转到保护模式下的代码执行。

### 从保护模式到实模式的转换
从保护模式切换回实模式的情况比较少见，但可以通过以下步骤实现：
1. 清除CR0寄存器的PE位。
2. 使用实模式的段选择子和代码段，跳转到实模式代码。
3. 重置GDT并重新配置段寄存器。

## 1.3 80x86系统指令寄存器
![x86 控制寄存器与 EFLAGS](https://www.lisha.ufsc.br/courses/Intel-Architecture.pdf)

在x86架构中，寄存器负责存储数据、控制信号以及系统状态信息。了解寄存器的作用对于理解指令执行和内存管理至关重要。

### 标志寄存器 EFLAGS
EFLAGS寄存器保存了当前指令执行的状态信息，提供给CPU关于上一次操作结果的反馈。该寄存器的各个位可以反映条件测试和控制处理器的行为。常见的重要标志包括：
- **IF（中断使能标志）**：决定是否允许硬件中断请求。如果IF=1，则处理器响应外部中断；如果IF=0，则中断被屏蔽。
- **ZF（零标志）**：在算术运算后，如果结果为零，ZF置1，表示结果为零。
- **CF（进位标志）**：当执行无符号运算时，如果运算结果产生进位，CF置1。
- **SF（符号标志）**：指示算术运算结果的符号。如果结果为负，SF置1。
- **OF（溢出标志）**：指示有符号运算的溢出情况。如果有符号加法或减法运算的结果超出了可表示范围，则OF置1。

### 内存管理寄存器
内存管理寄存器在保护模式下用于管理分段、分页以及任务的切换。这些寄存器存储系统内存描述符表的位置和当前任务的信息。
- **GDTR（全局描述符表寄存器）**：存储GDT的基地址和限长，用于定义全局段描述符。
- **LDTR（局部描述符表寄存器）**：存储LDT的基地址和限长，用于定义任务或进程的本地段描述符。
- **IDTR（中断描述符表寄存器）**：存储IDT的基地址和限长，中断处理器通过IDT查找中断服务程序。
- **TR（任务寄存器）**：存储当前任务的TSS选择子，TSS（任务状态段）用于保存当前任务的运行状态，如寄存器值、堆栈指针等。

### 控制寄存器
控制寄存器管理CPU的核心操作模式，特别是在分页、缓存控制和虚拟化方面。主要的控制寄存器包括：
- **CR0**：控制系统的整体工作模式，其中第0位PE用于启用保护模式，第31位PG用于启用分页。
- **CR2**：当分页机制启用时，CR2存储引发页错误的线性地址。
- **CR3**：存储页目录的基地址，在启用分页时，CR3用于指向页表的起始地址。
- **CR4**：用于启用额外的处理器特性，如物理地址扩展（PAE）和页全局使能（PGE）。

## 1.4 系统指令
![GDT 和 IDT 的位置与布局](https://www.cs.umd.edu/class/fall2020/cmsc411/slides/lecture6.pdf)

系统指令用于设置和操作处理器的系统级结构，例如描述符表、任务状态段和中断处理表。这些指令是操作系统实现内存管理、多任务处理和中断处理的核心。

### LGDT（Load Global Descriptor Table）
- **作用**：加载全局描述符表（GDT）的基地址和限长到GDTR寄存器中。
- **用法**：操作系统在启动时会通过LGDT指令设置GDT，从而启用分段内存管理。

### SGDT（Store Global Descriptor Table）
- **作用**：将GDTR寄存器中的GDT基地址和限长存储到内存中。
- **用法**：常用于调试和诊断，系统可以通过此指令来读取当前的GDT配置信息。

### LIDT（Load Interrupt Descriptor Table）
- **作用**：加载中断描述符表（IDT）的基地址和限长到IDTR寄存器中。
- **用法**：操作系统通过LIDT指令设置IDT，以处理中断和异常。

### SIDT（Store Interrupt Descriptor Table）
- **作用**：将IDTR寄存器中的IDT基地址和限长存储到内存中。
- **用法**：用于调试，读取当前的中断描述符表的配置信息。

### LLDT（Load Local Descriptor Table）
- **作用**：加载局部描述符表（LDT）的基地址和限长到LDTR寄存器中。
- **用法**：任务切换时，系统可能会通过LLDT指令为每个任务加载不同的LDT。

### SLDT（Store Local Descriptor Table）
- **作用**：将LDTR寄存器中的LDT基地址和限长存储到内存中。
- **用法**：用于调试和读取当前LDT配置信息。

### LTR（Load Task Register）
- **作用**：加载任务寄存器（TR），设置当前任务的TSS选择子。
- **用法**：操作系统通过LTR指令切换到一个新的任务状态段（TSS）。

### STR（Store Task Register）
- **作用**：将TR寄存器的内容（TSS选择子）存储到内存中。
- **用法**：常用于调试，读取当前任务状态段选择子。
